<!DOCTYPE html>
<html>
<head>
    <title>Feature Success</title>

    <script type="text/javascript" src="/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("Rally.technicalservices.ProgressCalculator",{extend:"Rally.data.lookback.calculator.TimeSeriesCalculator",config:{fieldName:null,fieldValues:[]},constructor:function(config){this.initConfig(config),this.callParent(arguments)},getMetrics:function(){return Ext.Array.map(this.fieldValues,function(fieldValue){return{as:fieldValue,groupByField:this.fieldName,allowedValues:[fieldValue],f:"groupByCount",display:"area"}},this)},prepareCalculator:function(calculatorConfig){var config=Ext.Object.merge(calculatorConfig,{granularity:this.config.granularity||this.lumenize.Time.DAY,tz:this.config.timeZone,holidays:this.config.holidays,workDays:this._getWorkdays()});return new this.lumenize.TimeSeriesCalculator(config)},runCalculation:function(snapshots){var calculatorConfig=this._prepareCalculatorConfig(),seriesConfig=this._buildSeriesConfig(calculatorConfig),calculator=this.prepareCalculator(calculatorConfig);calculator.addSnapshots(snapshots,this._getStartDate(snapshots),this._getEndDate(snapshots));var chart_data=this._transformLumenizeDataToHighchartsSeries(calculator,seriesConfig);return console.log(chart_data),chart_data.categories=Ext.Array.map(chart_data.categories,function(datum){return" "}),chart_data.series=this._updateColors(chart_data.series),console.log(chart_data),chart_data},_updateColors:function(chart_series){var updated_series=Ext.Array.map(chart_series,function(series){return console.log(series),series.name||(series.name="none"),"Abandon"==series.name&&(series.color="#F66349"),console.log(series),series});return updated_series}});
                Ext.define("Rally.technicalservices.ChartPopper",{extend:"Rally.ui.dialog.Dialog",id:"chartPopper",title:"Learning Flow",closable:!0,field:null,model:"PortfolioItem/Feature",parentRecord:null,items:[{xtype:"container",itemId:"display_box"}],initComponent:function(){this.callParent(arguments);var field=this.field,model=this.model;this._getValuesForField(model,field).then({scope:this,success:function(values){this._makeChart(model,field,values)},failure:function(msg){Ext.Msg.alert(msg)}})},_getValuesForField:function(model,field){var deferred=Ext.create("Deft.Deferred");return Rally.data.ModelFactory.getModel({type:model,success:function(model){model.getField(field).getAllowedValueStore().load({callback:function(records,operation,success){var values=Ext.Array.map(records,function(record){return record.get("StringValue")});deferred.resolve(values)}})},failure:function(msg){deferred.reject(msg)}}),deferred.promise},_makeChart:function(model,field,values){var container=this.down("#display_box");container.removeAll(),container.add({xtype:"rallychart",storeType:"Rally.data.lookback.SnapshotStore",storeConfig:this._getStoreConfig(model,field),calculatorType:"Rally.technicalservices.ProgressCalculator",calculatorConfig:{fieldName:field,fieldValues:values,granularity:"hour",startDate:Rally.util.DateTime.add(new Date,"hour",-30)},chartConfig:this._getChartConfig(),chartColors:["#000","#F66349","#8DC63F","#F8B500"]})},_getStoreConfig:function(model,field){return{find:{Parent:this.parentRecord.get("ObjectID"),_TypeHierarchy:model},fetch:[field],hydrate:[field]}},_getChartConfig:function(){return{chart:{zoomType:"xy"},title:{text:" "},xAxis:{tickmarkPlacement:"on",tickInterval:1},yAxis:[{title:{text:" "}}],plotOptions:{series:{marker:{enabled:!1}},area:{stacking:"normal"}},tooltip:{enabled:!1}}}});
                Ext.define("Rally.technicalservices.VariableComboBoxEditor",{extend:Ext.grid.CellEditor,alias:"widget.tsvariablecomboboxeditor",ignoreNoChange:!0,initComponent:function(){console.log("field:",this.field),this.callParent(arguments),this.field.on("select",this._onValueSelected,this)},getName:function(){return this.field&&this.field.getName()},getValue:function(){return this._valueSelected?this.callParent(arguments):this.startValue},_onValueSelected:function(){this._valueSelected=!0},onHide:function(){this.callParent(arguments),delete this._valueSelected,this.field.setValue("")},startEdit:function(el,value){this.field.setOriginalValue(value),this.callParent(arguments)}});
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",featureRecommendationDropdownField:"c_Recommendation",initiativeRecommendationDropdownField:"c_InitiativeRecommendation",recommendationSummaryField:"c_RecommendationSummary",winnerField:"c_Winner",voteField:"c_Votes",items:[{xtype:"container",itemId:"selector_box",padding:10},{xtype:"container",itemId:"display_box",padding:10}],launch:function(){var me=this,feature_fields=["FormattedID","Name","Notes","ConversationPost","PercentDoneByStoryCount","ObjectID",this.featureRecommendationDropdownField,this.initiativeRecommendationDropdownField,this.winnerField];Ext.create("Rally.data.wsapi.TreeStoreBuilder").build({models:["portfolioitem/theme"],fetch:feature_fields,autoLoad:!0,enableHierarchy:!0}).then({success:function(store){me.down("#display_box").add({xtype:"rallytreegrid",columnCfgs:me._getColumns(),store:store,listeners:{itemclick:function(view,record,item,index,evt){var column_index=view.getPositionByEvent(evt).column,columns=me._getColumns(),check_index=column_index-5;check_index>0&&("Notes"==columns[check_index].dataIndex&&me._showNotesPopup(record),"ObjectID"==columns[check_index].dataIndex&&"portfolioitem/initiative"==Ext.util.Format.lowercase(record.get("_type"))&&me._showInitiativeFlow(record))},scope:this}})}})},_addSelectors:function(container){container.add({xtype:"rallybutton",cls:"secondary",text:"Choose Initiative",listeners:{scope:this,click:this._launchPIPicker}})},_updateData:function(initiative){var me=this,feature_fields=["FormattedID","Name","Notes",this.featureRecommendationDropdownField,this.winnerField,this.recommendationSummaryField],feature_filter=[{property:"Parent.ObjectID",value:initiative.get("ObjectID")}];this._loadATypeWithAPromise("portfolioitem/feature",feature_fields,feature_filter).then({success:function(features){me._displayGrid(features)},failure:function(msg){Ext.Msg.alert(msg)}})},_loadATypeWithAPromise:function(model_name,model_fields,model_filter){var deferred=Ext.create("Deft.Deferred"),me=this;return Ext.create("Rally.data.wsapi.Store",{model:model_name,fetch:model_fields,filters:model_filter}).load({callback:function(records,operation,successful){successful?deferred.resolve(records):(console.log("Failed: ",operation),deferred.reject("Problem loading: "+operation.error.errors.join(". ")))}}),deferred.promise},_getColumns:function(){var me=this,specialComboFunction=function(field){return console.log("field",field),{xtype:"tsvariablecomboboxeditor",field:{xtype:"rallyfieldvaluecombobox",autoExpand:!0,field:field,storeConfig:{autoLoad:!1}}}},columns=[{dataIndex:"Name",text:"name"},{dataIndex:"PercentDoneByStoryCount",text:"Progress"},{dataIndex:this.featureRecommendationDropdownField,text:"Recommendation",listeners:{render:function(column){return console.log("col",column),console.log("editor",column.getEditor()),!0}},renderer:function(value,meta,record){return"portfolioitem/feature"==record.get("_type")&&("Abandon"==value&&(value="<span class='red_label right'>"+value+"</span>"),"Explore"==value&&(value="<span class='yellow_label right'>"+value+"</span>"),"Exploit"==value&&(value="<span class='green_label right'>"+value+"</span>")),"portfolioitem/initiative"==record.get("_type")&&(value=record.get(me.initiativeRecommendationDropdownField),"Pivot"==value&&(value="<span class='red_label'>"+value+"</span>"),"Persevere"==value&&(value="<span class='green_label'>"+value+"</span>")),value}},{dataIndex:"Notes",text:'<div class="icon-file"> </div>',width:25,editor:!1,renderer:function(value){return value?"<span class='icon-file'> </span>":""}},{dataIndex:"ObjectID",text:" ",width:25,editor:!1,renderer:function(value,meta,record){return"portfolioitem/initiative"==Ext.util.Format.lowercase(record.get("_type"))?"<span class='icon-graph'> </span>":""}},{dataIndex:this.winnerField,width:25,text:"",editor:"rallycheckboxfield",renderer:function(value){return value?"<span class='icon-flag'> </span>":""}},{dataIndex:"Discussion",width:35,text:""},{dataIndex:this.recommendationSummaryField,text:"Summary"}];return columns},_launchPIPicker:function(){var me=this;Ext.create("Rally.ui.dialog.ArtifactChooserDialog",{artifactTypes:["portfolioitem/initiative"],autoShow:!0,height:250,title:"Choose Initiative",multiple:!1,listeners:{artifactchosen:function(dialog,selectedRecord){me._updateData(selectedRecord)},scope:this}})},_showInitiativeFlow:function(record){var me=this,title=record.get("FormattedID")+": "+record.get("Name"),magic_renderer=function(field,value,meta_data,record){return me._magicRenderer(field,value,meta_data,record)};Ext.create("Rally.technicalservices.ChartPopper",{field:this.initiativeRecommendationDropdownField,width:Ext.getBody().getWidth()-25,height:Ext.getBody().getHeight()-25,parentRecord:record,field:this.featureRecommendationDropdownField,title:"Learning Flow: "+record.get("FormattedID")+": "+record.get("Name")}).show()},_showNotesPopup:function(record){var me=this,title=record.get("FormattedID")+": "+record.get("Name"),magic_renderer=function(field,value,meta_data,record){return me._magicRenderer(field,value,meta_data,record)};Ext.create("Rally.ui.dialog.Dialog",{id:"fieldPopup",title:title,width:Ext.getBody().getWidth()-25,height:Ext.getBody().getHeight()-25,closable:!0,items:[{xtype:"container",cls:"notes_recommendation",html:"Recomendation: "+record.get(me.featureRecommendationDropdownField)},{xtype:"container",cls:"notes_with_border",html:record.get("Notes")}]}).show()},_showInfoPopup:function(record,field_name){var me=this,title=record.get("FormattedID")+": "+record.get("Name"),magic_renderer=function(field,value,meta_data,record){return me._magicRenderer(field,value,meta_data,record)};Ext.create("Rally.ui.dialog.Dialog",{id:"fieldPopup",title:title,width:Ext.getBody().getWidth()-25,height:Ext.getBody().getHeight()-25,closable:!0,items:[{xtype:"container",html:record.get(field_name)}]}).show()}});

            Rally.launchApp('CustomApp', {
                name:"Feature Success",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .red_label{border:1px solid #F66349;background-color:#F66349;color:white;font-family:ProximaNovaSemiBold,helvetica,sans-serif;padding:4px;border-radius:4px;text-transform:uppercase}.green_label{border:1px solid #8DC63F;background-color:#8DC63F;color:white;font-family:ProximaNovaSemiBold,helvetica,sans-serif;padding:4px;border-radius:4px;text-transform:uppercase}.yellow_label{border:1px solid #F8B500;background-color:#F8B500;color:white;font-family:ProximaNovaSemiBold,helvetica,sans-serif;padding:4px;border-radius:4px;text-transform:uppercase;margin:0px auto}.rally-grid .x-grid-row-summary>.red>.x-grid-cell-inner,.rally-grid .red>.x-grid-cell-inner{border:1px solid #F66349;border-radius:4px;margin:2px;padding:4px 0 !important;text-align:center !important;color:white;text-transform:uppercase;background:#F66349}.rally-grid .x-grid-row-summary>.yellow>.x-grid-cell-inner,.rally-grid .yellow>.x-grid-cell-inner{border:1px solid #FAD200;border-radius:4px;margin:2px;padding:4px 0 !important;text-align:center !important;color:black;text-transform:uppercase;background:#FAD200}.rally-grid .x-grid-row-summary>.green>.x-grid-cell-inner,.rally-grid .green>.x-grid-cell-inner{border:1px solid #8DC63F;border-radius:4px;margin:2px;padding:4px 0 !important;text-align:center !important;color:white;text-transform:uppercase;background:#8DC63F}.rally-grid .x-grid-row-summary>.grey>.x-grid-cell-inner,.rally-grid .grey>.x-grid-cell-inner{border:1px solid #e4e4e4;border-radius:4px;margin:2px;padding:4px 0 !important;text-align:center !important;color:black;background:#8DC63F}.notes_recommendation{font-family:ProximaNovaSemiBold,Helvetica,Arial;font-size:12px;font-weight:normal;line-height:30px}.notes_with_border{border:1px solid blue}
    </style>
</head>
<body>
</body>
</html>
