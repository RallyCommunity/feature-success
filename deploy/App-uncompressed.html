<!DOCTYPE html>
<html>
<head>
    <title>Feature Success</title>

    <script type="text/javascript" src="/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define('Rally.technicalservices.VariableFieldValueComboBox', {
        extend: 'Rally.ui.combobox.ComboBox',
        alias: ['widget.tsvariablecombobox'],

        config: {
            /**
             * @cfg {Rally.data.Model/String} model (required) The model containing the specified field used to populate the store.
             * Not required if field is an instance of {Rally.data.Field}.
             */
            model: undefined,

            /**
             * @cfg {Rally.data.Field/String} field (required) The model's field, whose allowed values will be used to populate the store.
             */
            field: undefined,

            /**
             * @cfg {Object} context An object specifying the scoping settings for retrieving the specified model
             * If not specified the values provided by {Rally.env.Environment#getContext} will be used.
             */
            context: undefined,

            /**
             * @cfg {Object} storeConfig A configuration object which will be passed to the underlying data store
             */
            storeConfig: {
                autoLoad: true
            },

            /**
             * @cfg {Boolean}
             * If true, null will be used for the value of "-- No Entry --".  Otherwise, an empty string will be used.
             */
            useNullForNoEntryValue: false,

            queryMode: 'local',
            editable: true,
            typeAhead: true,
            forceSelection: true,
            selectOnFocus: true,
            valueField: 'value',
            displayField: 'name',
            ratingNoEntryString: 'None'
        },

        /**
         * @constructor
         */
        constructor: function(config) {
            if (config.field) {
                config.field = Ext.clone(config.field);
            }
            this.mergeConfig(config);

            this.store = Ext.create('Ext.data.Store', {
                fields: [this.valueField, this.displayField],
                data: []
            });

            return this.callParent([this.config]);
        },

        initComponent: function() {

            this.callParent(arguments);

            if(this.storeConfig && this.storeConfig.listeners) {
                this.store.on(this.storeConfig.listeners);
            }
            this.on('afterrender', this._onAfterRender, this);

            if (_.isString(this.model)) {
                this._fetchModel();
            } else if (this.storeConfig && this.storeConfig.autoLoad) {
                // Autoload is set to false if this field is created as part of a (grid) editor.
                // Do not load field data if this is in an editor.  Field will be loaded when showing editor.
                if (_.isString(this.field)) {
                    this.field = this.model.getField(this.field);
                }
                this._populateStore();
            }
        },

        setValue: function(value) {
            this.callParent([this.transformOriginalValue(value)]);
        },

        setField: function(field) {
            if (this.field !== field || !this.store.getCount()) {
                this.field = field;
                this._loadStoreValues();
            }
        },

        transformOriginalValue: function(value) {
            var val = value;
            if (value && value._ref) {
                val = value._ref;
            }
            return val;
        },

        _fetchModel: function() {
            Rally.data.ModelFactory.getModel({
                context: this.context,
                type: this.model,
                success: this._onModelRetrieved,
                scope: this
            });
        },

        _onModelRetrieved: function(model) {
            this.model = model;
            this.field = this.model.getField(this.field);
            this._populateStore();
        },

        _populateStore: function() {
            if (!this.field) {
                Ext.Error.raise('field config must be specified when creating a Rally.ui.combobox.FieldValueComboBox');
            }
            this._loadStoreValues();
        },

        _loadStoreValues: function() {
            this.field.getAllowedValueStore().load({
                requester: this,
                callback: function(records, operation, success) {
                    var store = this.store;
                    if (!store) {
                        return;
                    }
                    var noEntryValues = [],
                        labelValues = _.map(
                            _.filter(records, this._hasStringValue),
                            this._convertAllowedValueToLabelValuePair,
                            this
                        );

                    if (this.field.required === false) {
                        var name = "-- No Entry --",
                            value = "";
                        if (this.getUseNullForNoEntryValue()) {
                            value = null;
                        }
                        if (this.field.attributeDefinition.AttributeType.toLowerCase() === 'rating') {
                            name = this.getRatingNoEntryString();
                            value = "None";
                        }
                        noEntryValues.push(this._convertToLabelValuePair(name, value));
                    }
                    store.loadRawData(noEntryValues.concat(labelValues));
                    store.fireEvent('load', store, store.getRange(), success);
                },
                scope: this
            });
        },

        _hasStringValue: function(allowedValueObject) {
            return allowedValueObject.get('StringValue') !== "";
        },

        _convertAllowedValueToLabelValuePair: function(allowedValueObject) {
            var stringValue = allowedValueObject.get('StringValue');
            ref = allowedValueObject.get('_ref');
            return this._convertToLabelValuePair(stringValue, ref === NULL_REF ? stringValue : ref);
        },

        _convertToLabelValuePair: function(label, value) {
            var allowedValue = {};
            allowedValue[this.valueField] = value;
            allowedValue[this.displayField] = label;
            return allowedValue;
        },

        _onAfterRender: function() {
            this._afterRender = true;
            if(this._storeLoaded) {
                this.fireEvent('ready', this);
            }
        },

        onReady: function() {
            this._storeLoaded = true;
            if(this._afterRender) {
                this.fireEvent('ready', this);
            }
        },

        isEmpty: function() {
            var value = this.getValue();
            return _.isEmpty( value ) || value === this.getNoEntryValue();
        }
    });
                Ext.define('CustomApp', {
    extend: 'Rally.app.App',
    componentCls: 'app',
    featureRecommendationDropdownField: 'c_Recommendation',
    initiativeRecommendationDropdownField: 'c_InitiativeRecommendation',
    recommendationSummaryField: 'c_RecommendationSummary',
    winnerField: 'c_Winner',
    voteField: 'c_Votes',
    items: [
        {xtype:'container',itemId:'selector_box', padding: 10},
        {xtype:'container',itemId:'display_box', padding: 10}
    ],
    
    launch: function() {
        var me = this;
        var feature_fields = ['FormattedID','Name','Notes','ConversationPost','PercentDoneByStoryCount',
            this.featureRecommendationDropdownField, this.initiativeRecommendationDropdownField, this.winnerField];
        
        Ext.create('Rally.data.wsapi.TreeStoreBuilder').build({
            models: ['portfolioitem/theme'],
            fetch: feature_fields,
            autoLoad: true,
            enableHierarchy: true
        }).then({
            success: function(store) {
                me.down('#display_box').add({
                    xtype: 'rallytreegrid',
                    columnCfgs: me._getColumns(),
                    store: store,
                    listeners: {
                        itemclick: function(view, record, item, index, evt) {
                            var column_index = view.getPositionByEvent(evt).column;
                            var columns = me._getColumns();
                            var check_index = column_index - 5;
                            if (check_index > 0 ) {
                                if ( columns[check_index].dataIndex == "Notes" ) { 
                                    me._showNotesPopup(record);
                                }
                            }
                        },
                        scope : this
                    }
                });
             }
         });
    },
    
    _addSelectors: function(container) {
        container.add({
            xtype:'rallybutton', 
            cls:'secondary', 
            text:'Choose Initiative',
            listeners: {
                scope: this,
                click: this._launchPIPicker
            }
        });
    },
    
    _updateData: function(initiative) {
        var me = this;
        
        var feature_fields = ['FormattedID','Name','Notes',this.featureRecommendationDropdownField, this.winnerField, this.recommendationSummaryField];
        var feature_filter = [{property:'Parent.ObjectID', value:initiative.get('ObjectID')}];
        
        this._loadATypeWithAPromise('portfolioitem/feature',feature_fields, feature_filter ).then({
            success: function(features) {
                me._displayGrid(features);
            },
            failure: function(msg) {
                 Ext.Msg.alert(msg);
            }
        });
    },
    
    _loadATypeWithAPromise: function(model_name, model_fields,model_filter){
        var deferred = Ext.create('Deft.Deferred');
        var me = this;
          
        Ext.create('Rally.data.wsapi.Store', {
            model: model_name,
            fetch: model_fields,
            filters: model_filter
        }).load({
            callback : function(records, operation, successful) {
                if (successful){
                    deferred.resolve(records);
                } else {
                    console.log("Failed: ", operation);
                    deferred.reject('Problem loading: ' + operation.error.errors.join('. '));
                }
            }
        });
        return deferred.promise;
    },
    
    _getColumns: function() {
        var me = this;
        var columns = [
            {dataIndex:'Name', text:'name'},
            {dataIndex:'PercentDoneByStoryCount', text: 'Progress' },
            {dataIndex:this.featureRecommendationDropdownField, editor: 'tsvariablecombobox',  text:'Recommendation', 
                renderer: function(value,meta,record){
                    if ( record.get("_type") == "portfolioitem/feature") {
                        if ( value == "Abandon" ) {
                            value = "<span class='red_label right'>" + value + "</span>";
                            //meta.tdCls = "red";
                        }
                        if ( value == "Explore" ) {
                            value = "<span class='yellow_label right'>" + value + "</span>";
                        }
                        if ( value == "Exploit" ) {
                            value = "<span class='green_label right'>" + value + "</span>";
                        }
                    } 
                    
                    if ( record.get("_type") == "portfolioitem/initiative") {
                        value = record.get(me.initiativeRecommendationDropdownField);
                        
                        if ( value == "Pivot" ) {
                            value = "<span class='red_label'>" + value + "</span>";
                        }

                        if ( value == "Persevere" ) {
                            value = "<span class='green_label'>" + value + "</span>";
                        }
                    } 
                    return value;
                }
            },
            {dataIndex: this.recommendationSummaryField, text: 'Summary' },
            {dataIndex: 'Notes',text:'', width: 25, editor: false, 
                renderer: function(value) {
                    if (value) {
                        return "<span class='icon-comment'> </span>";
                    }
                    return "";
                }
            },
            {dataIndex:this.winnerField, width: 25, text:'',editor: 'rallycheckboxfield', 
                renderer: function(value) {
                    if (value) {
                        return "<span class='icon-flag'> </span>";
                    }
                    return "";
                }
            },
            {dataIndex:'Discussion', width: 35, text:''}
        ];
        
        return columns;
    },
    
    _displayGrid: function(records) {
        var me = this;
        var store = Ext.create('Rally.data.custom.Store',{data: records});
        var container = this.down('#display_box');
        
        container.removeAll();
        container.add({
            xtype:'rallygrid',
            columnCfgs: this._getColumns(),
            store: store,
            listeners: {
                itemclick: function(view, record, item, index, evt) {
                    var column_index = view.getPositionByEvent(evt).column;
                    var columns = me._getColumns();
                    console.log(columns[column_index].dataIndex);
                    if ( columns[column_index].dataIndex == "Notes" ) { 
                        // notes
                        me._showNotesPopup(record);
                    }
                },
                scope : this
            }
        });
    },
    
    _launchPIPicker: function() {
        var me = this;
        Ext.create('Rally.ui.dialog.ArtifactChooserDialog', {
            artifactTypes: ['portfolioitem/initiative'],
            autoShow: true,
            height: 250,
            title: 'Choose Initiative',
            multiple: false,
            listeners: {
                artifactchosen: function(dialog, selectedRecord){
                    me._updateData(selectedRecord);
                },
                scope: this
            }
         });
    },
    _showNotesPopup: function(record) {
        var me = this;
        var title = record.get('FormattedID') + ": " + record.get('Name');
        
        var magic_renderer = function(field,value,meta_data,record){
            return me._magicRenderer(field,value,meta_data,record);
        };
        
        Ext.create('Rally.ui.dialog.Dialog', {
            id        : 'fieldPopup',
            title     : title,
            width     : Ext.getBody().getWidth() - 25,
            height    : Ext.getBody().getHeight() - 25,
            closable  : true,
            items     : [
                { 
                    xtype: 'container', 
                    cls: 'notes_recommendation',
                    html: "Recomendation: " + record.get(me.featureRecommendationDropdownField) 
                },
                {
                    xtype:  'container',
                    cls: 'notes_with_border',
                    html: record.get('Notes')
                }
            ]
        }).show();
    },
    
    _showInfoPopup: function(record, field_name) {
        var me = this;
       
        var title = record.get('FormattedID') + ": " + record.get('Name');

        
        var magic_renderer = function(field,value,meta_data,record){
            return me._magicRenderer(field,value,meta_data,record);
        };
        
        Ext.create('Rally.ui.dialog.Dialog', {
            id        : 'fieldPopup',
            title     : title,
            width     : Ext.getBody().getWidth() - 25,
            height    : Ext.getBody().getHeight() - 25,
            closable  : true,
            /*layout    : 'fit',*/
            items     : [{
                xtype:  'container',
                html: record.get(field_name)
            }]
        }).show();
    }
});


            Rally.launchApp('CustomApp', {
                name:"Feature Success",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
  /* Add app styles here */
}
.red_label {
  border: 1px solid #F66349;
  background-color: #F66349;
  color: white;
  font-family: ProximaNovaSemiBold, helvetica, sans-serif;
  padding: 4px;
  border-radius: 4px;
  text-transform: uppercase;
}
.green_label {
  border: 1px solid #8DC63F;
  background-color: #8DC63F;
  color: white;
  font-family: ProximaNovaSemiBold, helvetica, sans-serif;
  padding: 4px;
  border-radius: 4px;
  text-transform: uppercase;
}
.yellow_label {
  border: 1px solid #F8B500;
  background-color: #F8B500;
  color: white;
  font-family: ProximaNovaSemiBold, helvetica, sans-serif;
  padding: 4px;
  border-radius: 4px;
  text-transform: uppercase;
  margin: 0px auto;
}
.rally-grid .x-grid-row-summary > .red > .x-grid-cell-inner,
.rally-grid .red > .x-grid-cell-inner {
  border: 1px solid #F66349;
  border-radius: 4px;
  margin: 2px;
  padding: 4px 0 !important;
  text-align: center !important;
  color: white;
  text-transform: uppercase;
  background: #F66349;
}
.rally-grid .x-grid-row-summary > .yellow > .x-grid-cell-inner,
.rally-grid .yellow > .x-grid-cell-inner {
  border: 1px solid #FAD200;
  border-radius: 4px;
  margin: 2px;
  padding: 4px 0 !important;
  text-align: center !important;
  color: black;
  text-transform: uppercase;
  background: #FAD200;
}
.rally-grid .x-grid-row-summary > .green > .x-grid-cell-inner,
.rally-grid .green > .x-grid-cell-inner {
  border: 1px solid #8DC63F;
  border-radius: 4px;
  margin: 2px;
  padding: 4px 0 !important;
  text-align: center !important;
  color: white;
  text-transform: uppercase;
  background: #8DC63F;
}
.rally-grid .x-grid-row-summary > .grey > .x-grid-cell-inner,
.rally-grid .grey > .x-grid-cell-inner {
  border: 1px solid #e4e4e4;
  border-radius: 4px;
  margin: 2px;
  padding: 4px 0 !important;
  text-align: center !important;
  color: black;
  background: #8DC63F;
}
.notes_recommendation {
  font-family: ProximaNovaSemiBold,Helvetica,Arial;
  font-size: 12px;
  font-weight: normal;
  line-height: 30px;
}
.notes_with_border {
  border: 1px solid blue;
}

    </style>
</head>
<body>
</body>
</html>
