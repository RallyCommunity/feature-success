<!DOCTYPE html>
<html>
<head>
    <title>Feature Success</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("Rally.technicalservices.VariableFieldValueComboBox",{extend:"Rally.ui.combobox.ComboBox",alias:["widget.tsvariablecombobox"],config:{model:void 0,field:void 0,context:void 0,storeConfig:{autoLoad:!0},useNullForNoEntryValue:!1,queryMode:"local",editable:!0,typeAhead:!0,forceSelection:!0,selectOnFocus:!0,valueField:"value",displayField:"name",ratingNoEntryString:"None"},constructor:function(config){return config.field&&(config.field=Ext.clone(config.field)),this.mergeConfig(config),this.store=Ext.create("Ext.data.Store",{fields:[this.valueField,this.displayField],data:[]}),this.callParent([this.config])},initComponent:function(){this.callParent(arguments),this.storeConfig&&this.storeConfig.listeners&&this.store.on(this.storeConfig.listeners),this.on("afterrender",this._onAfterRender,this),_.isString(this.model)?this._fetchModel():this.storeConfig&&this.storeConfig.autoLoad&&(_.isString(this.field)&&(this.field=this.model.getField(this.field)),this._populateStore())},setValue:function(value){this.callParent([this.transformOriginalValue(value)])},setField:function(field){this.field===field&&this.store.getCount()||(this.field=field,this._loadStoreValues())},transformOriginalValue:function(value){var val=value;return value&&value._ref&&(val=value._ref),val},_fetchModel:function(){Rally.data.ModelFactory.getModel({context:this.context,type:this.model,success:this._onModelRetrieved,scope:this})},_onModelRetrieved:function(model){this.model=model,this.field=this.model.getField(this.field),this._populateStore()},_populateStore:function(){this.field||Ext.Error.raise("field config must be specified when creating a Rally.ui.combobox.FieldValueComboBox"),this._loadStoreValues()},_loadStoreValues:function(){this.field.getAllowedValueStore().load({requester:this,callback:function(records,operation,success){var store=this.store;if(store){var noEntryValues=[],labelValues=_.map(_.filter(records,this._hasStringValue),this._convertAllowedValueToLabelValuePair,this);if(this.field.required===!1){var name="-- No Entry --",value="";this.getUseNullForNoEntryValue()&&(value=null),"rating"===this.field.attributeDefinition.AttributeType.toLowerCase()&&(name=this.getRatingNoEntryString(),value="None"),noEntryValues.push(this._convertToLabelValuePair(name,value))}store.loadRawData(noEntryValues.concat(labelValues)),store.fireEvent("load",store,store.getRange(),success)}},scope:this})},_hasStringValue:function(allowedValueObject){return""!==allowedValueObject.get("StringValue")},_convertAllowedValueToLabelValuePair:function(allowedValueObject){var stringValue=allowedValueObject.get("StringValue");return ref=allowedValueObject.get("_ref"),this._convertToLabelValuePair(stringValue,ref===NULL_REF?stringValue:ref)},_convertToLabelValuePair:function(label,value){var allowedValue={};return allowedValue[this.valueField]=value,allowedValue[this.displayField]=label,allowedValue},_onAfterRender:function(){this._afterRender=!0,this._storeLoaded&&this.fireEvent("ready",this)},onReady:function(){this._storeLoaded=!0,this._afterRender&&this.fireEvent("ready",this)},isEmpty:function(){var value=this.getValue();return _.isEmpty(value)||value===this.getNoEntryValue()}});
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",featureRecommendationDropdownField:"c_Recommendation",initiativeRecommendationDropdownField:"c_InitiativeRecommendation",recommendationSummaryField:"c_RecommendationSummary",winnerField:"c_Winner",voteField:"c_Votes",items:[{xtype:"container",itemId:"selector_box",padding:10},{xtype:"container",itemId:"display_box",padding:10}],launch:function(){var me=this,feature_fields=["FormattedID","Name","Notes","ConversationPost","PercentDoneByStoryCount",this.featureRecommendationDropdownField,this.initiativeRecommendationDropdownField,this.winnerField];Ext.create("Rally.data.wsapi.TreeStoreBuilder").build({models:["portfolioitem/theme"],fetch:feature_fields,autoLoad:!0,enableHierarchy:!0}).then({success:function(store){me.down("#display_box").add({xtype:"rallytreegrid",columnCfgs:me._getColumns(),store:store,listeners:{itemclick:function(view,record,item,index,evt){var column_index=view.getPositionByEvent(evt).column,columns=me._getColumns(),check_index=column_index-5;check_index>0&&"Notes"==columns[check_index].dataIndex&&me._showNotesPopup(record)},scope:this}})}})},_addSelectors:function(container){container.add({xtype:"rallybutton",cls:"secondary",text:"Choose Initiative",listeners:{scope:this,click:this._launchPIPicker}})},_updateData:function(initiative){var me=this,feature_fields=["FormattedID","Name","Notes",this.featureRecommendationDropdownField,this.winnerField,this.recommendationSummaryField],feature_filter=[{property:"Parent.ObjectID",value:initiative.get("ObjectID")}];this._loadATypeWithAPromise("portfolioitem/feature",feature_fields,feature_filter).then({success:function(features){me._displayGrid(features)},failure:function(msg){Ext.Msg.alert(msg)}})},_loadATypeWithAPromise:function(model_name,model_fields,model_filter){var deferred=Ext.create("Deft.Deferred"),me=this;return Ext.create("Rally.data.wsapi.Store",{model:model_name,fetch:model_fields,filters:model_filter}).load({callback:function(records,operation,successful){successful?deferred.resolve(records):(console.log("Failed: ",operation),deferred.reject("Problem loading: "+operation.error.errors.join(". ")))}}),deferred.promise},_getColumns:function(){var me=this,columns=[{dataIndex:"Name",text:"name"},{dataIndex:"PercentDoneByStoryCount",text:"Progress"},{dataIndex:this.featureRecommendationDropdownField,editor:"tsvariablecombobox",text:"Recommendation",renderer:function(value,meta,record){return"portfolioitem/feature"==record.get("_type")&&("Abandon"==value&&(value="<span class='red_label right'>"+value+"</span>"),"Explore"==value&&(value="<span class='yellow_label right'>"+value+"</span>"),"Exploit"==value&&(value="<span class='green_label right'>"+value+"</span>")),"portfolioitem/initiative"==record.get("_type")&&(value=record.get(me.initiativeRecommendationDropdownField),"Pivot"==value&&(value="<span class='red_label'>"+value+"</span>"),"Persevere"==value&&(value="<span class='green_label'>"+value+"</span>")),value}},{dataIndex:this.recommendationSummaryField,text:"Summary"},{dataIndex:"Notes",text:"",width:25,editor:!1,renderer:function(value){return value?"<span class='icon-comment'> </span>":""}},{dataIndex:this.winnerField,width:25,text:"",editor:"rallycheckboxfield",renderer:function(value){return value?"<span class='icon-flag'> </span>":""}},{dataIndex:"Discussion",width:35,text:""}];return columns},_displayGrid:function(records){var me=this,store=Ext.create("Rally.data.custom.Store",{data:records}),container=this.down("#display_box");container.removeAll(),container.add({xtype:"rallygrid",columnCfgs:this._getColumns(),store:store,listeners:{itemclick:function(view,record,item,index,evt){var column_index=view.getPositionByEvent(evt).column,columns=me._getColumns();console.log(columns[column_index].dataIndex),"Notes"==columns[column_index].dataIndex&&me._showNotesPopup(record)},scope:this}})},_launchPIPicker:function(){var me=this;Ext.create("Rally.ui.dialog.ArtifactChooserDialog",{artifactTypes:["portfolioitem/initiative"],autoShow:!0,height:250,title:"Choose Initiative",multiple:!1,listeners:{artifactchosen:function(dialog,selectedRecord){me._updateData(selectedRecord)},scope:this}})},_showNotesPopup:function(record){var me=this,title=record.get("FormattedID")+": "+record.get("Name"),magic_renderer=function(field,value,meta_data,record){return me._magicRenderer(field,value,meta_data,record)};Ext.create("Rally.ui.dialog.Dialog",{id:"fieldPopup",title:title,width:Ext.getBody().getWidth()-25,height:Ext.getBody().getHeight()-25,closable:!0,items:[{xtype:"container",cls:"notes_recommendation",html:"Recomendation: "+record.get(me.featureRecommendationDropdownField)},{xtype:"container",cls:"notes_with_border",html:record.get("Notes")}]}).show()},_showInfoPopup:function(record,field_name){var me=this,title=record.get("FormattedID")+": "+record.get("Name"),magic_renderer=function(field,value,meta_data,record){return me._magicRenderer(field,value,meta_data,record)};Ext.create("Rally.ui.dialog.Dialog",{id:"fieldPopup",title:title,width:Ext.getBody().getWidth()-25,height:Ext.getBody().getHeight()-25,closable:!0,items:[{xtype:"container",html:record.get(field_name)}]}).show()}});

            Rally.launchApp('CustomApp', {
                name:"Feature Success",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .red_label{border:1px solid #F66349;background-color:#F66349;color:white;font-family:ProximaNovaSemiBold,helvetica,sans-serif;padding:4px;border-radius:4px;text-transform:uppercase}.green_label{border:1px solid #8DC63F;background-color:#8DC63F;color:white;font-family:ProximaNovaSemiBold,helvetica,sans-serif;padding:4px;border-radius:4px;text-transform:uppercase}.yellow_label{border:1px solid #F8B500;background-color:#F8B500;color:white;font-family:ProximaNovaSemiBold,helvetica,sans-serif;padding:4px;border-radius:4px;text-transform:uppercase;margin:0px auto}.rally-grid .x-grid-row-summary>.red>.x-grid-cell-inner,.rally-grid .red>.x-grid-cell-inner{border:1px solid #F66349;border-radius:4px;margin:2px;padding:4px 0 !important;text-align:center !important;color:white;text-transform:uppercase;background:#F66349}.rally-grid .x-grid-row-summary>.yellow>.x-grid-cell-inner,.rally-grid .yellow>.x-grid-cell-inner{border:1px solid #FAD200;border-radius:4px;margin:2px;padding:4px 0 !important;text-align:center !important;color:black;text-transform:uppercase;background:#FAD200}.rally-grid .x-grid-row-summary>.green>.x-grid-cell-inner,.rally-grid .green>.x-grid-cell-inner{border:1px solid #8DC63F;border-radius:4px;margin:2px;padding:4px 0 !important;text-align:center !important;color:white;text-transform:uppercase;background:#8DC63F}.rally-grid .x-grid-row-summary>.grey>.x-grid-cell-inner,.rally-grid .grey>.x-grid-cell-inner{border:1px solid #e4e4e4;border-radius:4px;margin:2px;padding:4px 0 !important;text-align:center !important;color:black;background:#8DC63F}.notes_recommendation{font-family:ProximaNovaSemiBold,Helvetica,Arial;font-size:12px;font-weight:normal;line-height:30px}.notes_with_border{border:1px solid blue}
    </style>
</head>
<body>
</body>
</html>
